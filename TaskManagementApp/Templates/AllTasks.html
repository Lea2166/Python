{% extends 'base.html' %}

{% block content %}
<style>
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-task { opacity: 0; animation: fadeInUp 0.5s ease-out forwards; }
    .status-pulse { animation: pulse 2s infinite; }
    .glass-effect { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); }
    :root { color-scheme: dark !important; }

    /* Date field styling */
    .custom-calendar-input {
        position: relative;
        background-color: #1e293b !important;
        color: white !important;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
    }

    .custom-calendar-input::-webkit-calendar-picker-indicator {
        position: absolute;
        right: 0;
        top: 0;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        cursor: pointer;
        opacity: 0;
        z-index: 2;
    }

    .calendar-icon-svg {
        z-index: 1;
        pointer-events: none;
    }

    input[type="date"]::-webkit-datetime-edit-text,
    input[type="date"]::-webkit-datetime-edit-month-field,
    input[type="date"]::-webkit-datetime-edit-day-field,
    input[type="date"]::-webkit-datetime-edit-year-field {
        color: white !important;
    }
</style>

<div class="min-h-screen bg-slate-950 p-4 md:p-8 text-slate-200 font-sans w-full" dir="ltr">
    <div class="max-w-6xl mx-auto space-y-10">

        <div class="bg-slate-900/50 border border-slate-800 shadow-2xl rounded-[2.5rem] p-8 md:p-10 flex flex-col md:flex-row justify-between items-center gap-6 relative overflow-hidden">
            <div class="absolute -top-24 -left-24 w-64 h-64 bg-purple-600/10 blur-[100px] rounded-full"></div>

            <div class="space-y-2 text-left w-full relative z-10">
                <h1 class="text-5xl font-black text-white tracking-tighter">
                    {% if user_role == 'ADMIN' %}<span class="text-purple-500">Admin</span> Dashboard{% else %}Task Management{% endif %}
                </h1>
                <p class="text-slate-400 font-bold text-lg flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    Viewing: <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-500 font-black">{{ team_name }}</span>
                </p>
            </div>

            {% if user_role == 'ADMIN' %}
            <div class="relative z-10 shrink-0">
                <a href="{% url 'add_task' %}" class="relative inline-flex items-center justify-center p-0.5 overflow-hidden text-sm font-black rounded-2xl group bg-gradient-to-br from-purple-600 to-blue-500 text-white transition-all transform hover:scale-105 active:scale-95 shadow-xl shadow-purple-900/20">
                    <span class="relative px-8 py-4 transition-all bg-slate-900 rounded-[14px] group-hover:bg-transparent">+ New Task</span>
                </a>
            </div>
            {% endif %}
        </div>

        <div class="glass-effect border border-slate-800 rounded-[2.5rem] shadow-xl p-8 flex flex-wrap gap-12 items-start">
            <div class="space-y-4">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] ml-1">Filter Ownership</p>
                <div class="flex flex-wrap gap-3">
                    {% for o_val, o_label in owner_options %}
                        {% if user_role == 'ADMIN' and o_val == 'mine' %}
                            {# Admin sees everything #}
                        {% else %}
                        <a href="?owner={{ o_val }}&status={{ status_filter }}"
                           class="relative inline-flex items-center justify-center p-0.5 overflow-hidden text-xs font-bold rounded-xl group transition-all {% if owner_filter == o_val %} bg-gradient-to-br from-purple-600 to-blue-500 shadow-lg shadow-purple-500/20 {% else %} bg-slate-800 {% endif %}">
                            <span class="relative px-6 py-2.5 transition-all ease-in duration-75 bg-slate-900 rounded-[10px] group-hover:bg-transparent leading-5">
                                {% if o_label == 'All' %}All Tasks{% elif o_label == 'Mine' %}My Tasks{% else %}{{ o_label }}{% endif %}
                            </span>
                        </a>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="space-y-4">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] ml-1">Status</p>
                <div class="flex flex-wrap gap-3">
                    {% for s_val, s_label in status_options %}
                    <a href="?owner={{ owner_filter }}&status={{ s_val }}"
                       class="relative inline-flex items-center justify-center p-0.5 overflow-hidden text-[10px] font-bold rounded-xl group transition-all {% if status_filter == s_val %} bg-gradient-to-br from-purple-600 to-blue-500 shadow-lg shadow-purple-500/20 {% else %} bg-slate-800 {% endif %}">
                        <span class="relative px-5 py-2.5 bg-slate-900 rounded-[10px] group-hover:bg-transparent uppercase tracking-widest">
                            {% if s_label == 'All' %}Show All{% else %}{{ s_label }}{% endif %}
                        </span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="bg-slate-900/30 border border-slate-800 shadow-2xl rounded-[3rem] overflow-hidden backdrop-blur-sm">
            <ul class="divide-y divide-slate-800/50">
                {% for task in tasks %}
                <li class="p-8 md:p-10 hover:bg-slate-800/30 transition-all group animate-task" style="animation-delay: 0.{{ forloop.counter0 }}s">
                    <div class="flex flex-col md:flex-row items-center gap-8 text-left">

                        <div class="shrink-0 relative">
                            <div class="w-20 h-20 rounded-[1.5rem] flex items-center justify-center border-2 transition-transform duration-500 group-hover:rotate-6
                                {% if task.Status == 'NEW' %} border-blue-500/40 text-blue-400 bg-blue-500/10
                                {% elif task.Status == 'IN_PROGRESS' %} border-orange-500/40 text-orange-400 bg-orange-500/10
                                {% else %} border-emerald-500/40 text-emerald-400 bg-emerald-500/10 {% endif %}">
                                <svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                            </div>
                        </div>

                        <div class="flex-1 space-y-4">
                            <div class="flex flex-wrap items-center gap-4">
                                <h3 class="text-3xl font-black text-white group-hover:text-purple-400 transition-colors duration-300">{{ task.Name }}</h3>
                                <span class="text-[10px] px-3 py-1 rounded-full border border-slate-700 bg-slate-800 text-slate-400 font-black tracking-tighter uppercase">{{ task.Status }}</span>
                            </div>
                            <p class="text-s font-black text-white group-hover:text-purple-400 transition-colors duration-300">{{task.Description}}</p>

                            <div class="flex flex-wrap gap-8 text-sm font-bold">
                                <span class="flex items-center gap-2 text-slate-500">
                                    <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    Due: <span class="text-slate-200">{{ task.Due_Date|date:"d/m/Y" }}</span>
                                </span>
                                <span class="flex items-center gap-2 text-slate-500">
                                    <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    Assignee: <span class="text-blue-400">{{ task.AssignedUser.username|default:"Unassigned" }}</span>
                                </span>
                            </div>
                        </div>

                        <div class="flex gap-4 items-center">
                            {% if user_role == 'ADMIN' %}
                                {% if not task.AssignedUser %}
                                <a href="{% url 'edit_task' task.Id %}" class="p-4 bg-slate-800/50 text-blue-400 border border-slate-700 rounded-2xl hover:bg-blue-500 hover:text-white transition-all transform hover:-translate-y-1" title="Edit Task">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </a>
                                <a href="{% url 'delete_task' task.Id %}" onclick="return confirm('Delete permanently?')" class="p-4 bg-slate-800/50 text-rose-500 border border-slate-700 rounded-2xl hover:bg-rose-500 hover:text-white transition-all transform hover:-translate-y-1" title="Delete Task">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </a>
                                {% endif %}
                            {% endif %}

                            {% if not task.AssignedUser and user_role == 'EMPLOYEE' %}
                                <a href="{% url 'claim_task' task.Id %}" class="px-8 py-4 bg-gradient-to-br from-purple-600 to-blue-500 rounded-2xl font-black text-white shadow-lg shadow-purple-900/20 transform hover:scale-105 transition-all">Claim Task</a>
                            {% endif %}

                            {% if task.AssignedUser == request.user and task.Status == 'IN_PROGRESS' %}
                                <a href="{% url 'finish_task' task.Id %}" class="px-8 py-4 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl font-black text-white shadow-lg shadow-emerald-900/20 transform hover:scale-105 transition-all">Complete!</a>
                            {% endif %}
                        </div>
                    </div>
                </li>
                {% empty %}
                <div class="py-32 text-center opacity-40">
                    <p class="text-slate-500 text-xl font-black italic tracking-widest uppercase underline decoration-purple-500 underline-offset-8">No tasks found</p>
                </div>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}